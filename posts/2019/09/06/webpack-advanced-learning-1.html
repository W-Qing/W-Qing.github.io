<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Webpack 进阶学习（一） | ☀️W-Qing</title>
    <meta name="description" content="入门了 Webpack4.0，然后是对一些进阶概念的学习与理解的笔记。 ">
    <link rel="shortcut icon" href="/img/favicon-32.ico">
    
    <link rel="preload" href="/assets/css/1.styles.8681790c.css" as="style"><link rel="preload" href="/assets/js/vendor.2.8681790c.js" as="script"><link rel="preload" href="/assets/js/vendor.1.d0cf3ae5.js" as="script"><link rel="preload" href="/assets/css/0.styles.6b1a4519.css" as="style"><link rel="preload" href="/assets/js/vendor.0.6b1a4519.js" as="script"><link rel="preload" href="/assets/js/app.a5059352.js" as="script"><link rel="preload" href="/assets/js/25.b68f41ab.js" as="script"><link rel="prefetch" href="/assets/css/4.styles.2f04305e.css"><link rel="prefetch" href="/assets/css/5.styles.89162a5d.css"><link rel="prefetch" href="/assets/css/6.styles.99a56a85.css"><link rel="prefetch" href="/assets/css/7.styles.53d3c094.css"><link rel="prefetch" href="/assets/js/10.ba35610d.js"><link rel="prefetch" href="/assets/js/11.89dc6fd2.js"><link rel="prefetch" href="/assets/js/12.af9a49fe.js"><link rel="prefetch" href="/assets/js/13.12238301.js"><link rel="prefetch" href="/assets/js/14.874bbe6f.js"><link rel="prefetch" href="/assets/js/15.70e53660.js"><link rel="prefetch" href="/assets/js/16.702d2711.js"><link rel="prefetch" href="/assets/js/17.9ee8bb80.js"><link rel="prefetch" href="/assets/js/18.16a874e3.js"><link rel="prefetch" href="/assets/js/19.1f0fe006.js"><link rel="prefetch" href="/assets/js/20.1c173acf.js"><link rel="prefetch" href="/assets/js/21.a65fd53c.js"><link rel="prefetch" href="/assets/js/22.817c26f4.js"><link rel="prefetch" href="/assets/js/23.7d8ddf80.js"><link rel="prefetch" href="/assets/js/24.719ebfd1.js"><link rel="prefetch" href="/assets/js/26.6a17249a.js"><link rel="prefetch" href="/assets/js/27.8e7e4ae8.js"><link rel="prefetch" href="/assets/js/28.0ede4f7f.js"><link rel="prefetch" href="/assets/js/29.503b4d2b.js"><link rel="prefetch" href="/assets/js/30.38ae75d9.js"><link rel="prefetch" href="/assets/js/4.2f04305e.js"><link rel="prefetch" href="/assets/js/5.89162a5d.js"><link rel="prefetch" href="/assets/js/6.99a56a85.js"><link rel="prefetch" href="/assets/js/7.53d3c094.js"><link rel="prefetch" href="/assets/js/8.cec7f5a5.js"><link rel="prefetch" href="/assets/js/9.e86e8d29.js">
    <link rel="stylesheet" href="/assets/css/1.styles.8681790c.css"><link rel="stylesheet" href="/assets/css/0.styles.6b1a4519.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-meteorlxy"><header class="header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/background/header.jpg);" data-v-0539f1bd><div data-v-39c72c19 data-v-0539f1bd><nav class="navbar" data-v-39c72c19><div class="container" data-v-39c72c19><a href="/" class="router-link-active" data-v-39c72c19><span class="navbar-site-name" data-v-39c72c19>
          ☀️W-Qing
        </span></a> <div class="navbar-toggler" data-v-39c72c19><svg class="icon" style="font-size:1.2em;" data-v-39c72c19 data-v-39c72c19><title data-v-39c72c19 data-v-39c72c19>menu</title><use xlink:href="#icon-menu" data-v-39c72c19 data-v-39c72c19></use></svg></div> <div class="navbar-links" data-v-39c72c19><a href="/" class="navbar-link" data-v-39c72c19>
            Home
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-39c72c19>
            Posts
          </a><a href="/life" class="navbar-link" data-v-39c72c19>
            Life
          </a><a href="/about/" class="navbar-link" data-v-39c72c19>
            About
          </a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-39c72c19></div></div> <div class="banner" data-v-98d6aa8c data-v-0539f1bd data-v-0539f1bd><div class="container" data-v-98d6aa8c><div class="center" data-v-98d6aa8c><h1 data-v-98d6aa8c data-v-0539f1bd>
          Webpack 进阶学习（一）
        </h1></div></div></div></header> <div class="container clearfix show-aside" data-v-6cd81e6a data-v-6cd81e6a><main class="main" data-v-6cd81e6a><div class="post" data-v-6cd81e6a data-v-6cd81e6a><section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      发布时间 : 2019-09-06
    </span> <!----></section> <section class="post-links" data-v-4e23451f><a href="/posts/2019/07/05/react-docs-notes.html" class="post-link" data-v-4e23451f>
      上一篇 : React文档学习笔记
    </a> <!----></section></section> <article class="main-div"><div class="post-content content content__default"><h2 id="entry-与-output-的基础配置"><a href="#entry-与-output-的基础配置" aria-hidden="true" class="header-anchor">#</a> Entry 与 Output 的基础配置</h2> <p>通过 <a href="https://sunburst.wang/posts/2018/12/28/webpack-quick-start.html" target="_blank" rel="noopener noreferrer">《webpack 快速入门》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的基础学习，已经了解到应用程序通过 webpack 执行打包的入口 entry 及文件输出 output。它们的默认值分别是 <code>'./src'</code> 和 <code>main.js</code>。</p> <p>但如果我们的项目是一个可能会有多个入口文件的多页面的应用。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    home<span class="token punctuation">:</span> <span class="token string">'./home.js'</span><span class="token punctuation">,</span>
    about<span class="token punctuation">:</span> <span class="token string">'./about.js'</span><span class="token punctuation">,</span>
    contact<span class="token punctuation">:</span> <span class="token string">'./contact.js'</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>那么此时 output 下的配置也要进行相应的更改。最简单的方式就是通过占位符去设置打包输出的文件名。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  publicPath<span class="token punctuation">:</span> <span class="token string">'http://cdn.com'</span> <span class="token comment">// 或指定目录 '/assets/',</span>
  filename<span class="token punctuation">:</span> <span class="token string">'[name].js'</span> <span class="token comment">// name 占位符</span>
<span class="token punctuation">}</span>
<span class="token comment">// 打包输出 home.js、about.js、contact.js</span>
</code></pre></div><p>很多时候我们可能会将打包生成的文件给后端或者将资源托管到 CDN 时。那么我们在打包生成的 html 文件内去引用这些文件就需要一个指定的 URL 前缀。打包后的文件在 html 内的引用方式会如下所示：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://cdn.com/about.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>查阅文档，学习更多 <a href="https://webpack.docschina.org/configuration/entry-context/#entry" target="_blank" rel="noopener noreferrer">entry<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 与 <a href="https://webpack.docschina.org/configuration/output/" target="_blank" rel="noopener noreferrer">output<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的配置参数以及 <a href="https://webpack.docschina.org/guides/output-management/" target="_blank" rel="noopener noreferrer">Output Management<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的知识。</p> <h2 id="source-map-的配置"><a href="#source-map-的配置" aria-hidden="true" class="header-anchor">#</a> Source Map 的配置</h2> <p>当 webpack 打包源代码时，可能会很难追踪到 error（错误） 和 warning（警告） 在源代码中的原始位置。</p> <p>例如，如果将三个源文件（<code>a.js</code>, <code>b.js</code> 和 <code>c.js</code>）打包到一个 bundle（<code>bundle.js</code>）中，而其中一个源文件包含一个错误，那么堆栈跟踪就会直接指向到 <code>bundle.js</code>。你可能需要准确地知道错误来自于哪个源文件，所以这种提示这通常不会提供太多帮助。</p> <p>为了更容易地追踪 error 和 warning，JavaScript 提供了 <a href="http://blog.teamtreehouse.com/introduction-source-maps" target="_blank" rel="noopener noreferrer">source map<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 功能（一个映射关系），可以将编译后的代码映射回原始源代码。</p> <p>通过设置 webpack 的 devtool 属性就可以配置 Scource Map。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// ...</span>
mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span> <span class="token comment">// 开发环境</span>
devtool<span class="token punctuation">:</span> <span class="token string">'source-map'</span><span class="token punctuation">,</span> <span class="token comment">// 默认为 none</span>
</code></pre></div><p>重新打包后，如果有报错或者警告信息那么就可以通过控制台提示定位到对应位置的代码。</p> <p>同时 dist 目录下会增加一个 <code>bundle.js.map</code> 文件。打包后的文件代码与源代码就是通过这个文件进行映射的。</p> <p>查看文档，webpack 提供了十几种 <a href="https://webpack.docschina.org/configuration/devtool/" target="_blank" rel="noopener noreferrer">source map<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的配置格式。其中：</p> <ol><li><p><code>inline-source-map</code></p> <p>效果与 source map 一致，区别在于这种方式不会生成 map 文件，而是将其映射关系的内容通过 dataUrl 的方式直接写入到打包后的 bundle.js 文件底部。</p></li> <li><p><code>inline-cheap-source-map</code></p> <p>上面提到的配置格式，在提示错误和警告信息的时候，会帮我们精确到项目文件代码中的具体某行某列。</p> <p>而加了 cheap 之后，它只会精确到行，而不会精确到哪一列。同时，它会只关心我们写的业务代码，不再关心其他部分的代码，所以这种方式的构建过程就会变得比较快。</p></li> <li><p><code>inline-cheap-module-source-map</code></p> <p>如果我们在 cheap 的基础上还想让 webpack 为我们提供 loader、第三方模块等部分代码的错误信息，那么可以加上 module 关键字。</p></li> <li><p><code>eval</code></p> <p>效果与 source map 的方式是一样的，但是 dist 目录下不会生成 map 文件，同时 bundle.js 文件底部也没有 Base64 的 dataUrl 字段。但是有一个 eval() 方法，所以它是通过 eval 的 js 执行形式来生成 source map 的对应关系的。</p> <p>这种方式是执行效率最快，性能最好的方式，但缺点是针对于比较复杂的代码情况下，不能正确的显示行数。</p></li></ol> <p><strong>最佳实践：</strong></p> <ul><li>开发环境 development: <code>cheap-module-eval-source-map</code></li> <li>生成环境 production: <code>none</code> 或 <code>cheap-module-source-map</code></li> <li>或者使用 <a href="https://webpack.docschina.org/plugins/source-map-dev-tool-plugin" target="_blank" rel="noopener noreferrer">SourceMapDevToolPlugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 进行更细粒度的配置。(<em>切勿和 devtool 选项同时使用</em> )</li></ul> <h2 id="模块热更新-hot-module-replace"><a href="#模块热更新-hot-module-replace" aria-hidden="true" class="header-anchor">#</a> 模块热更新 Hot Module Replace</h2> <p>在我们使用 webpack-dev-server 实现代码的热加载之后，每次源代码有改动，这个本地服务器就会自动帮我们打包并刷新浏览器。这确实很方便，但其实有时候我们其实却并不希望它去刷新页面。</p> <blockquote><p>比如，我们在页面上通过很多的点击交互操作，最终在页面显示出一个特定列表。然后为了修改列表项样式，我们对源代码做了更改。如果此时 webpack-dev-server 帮我们自动刷新浏览器页面了，那我们就需要再重新进行一遍点击操作才能看到更改样式后的列表… 😟</p></blockquote> <p>此时我们就可以使用 webpack-dev-server 的模块热更新功能 (HMR)。</p> <ol><li>修改 devServer 配置项</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  port<span class="token punctuation">:</span> <span class="token number">8086</span><span class="token punctuation">,</span>
  hot<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 开启 hmr 功能</span>
  hotOnly<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment">// 可选，意思是即使 hrm 不生效，浏览器也不刷新</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><ol start="2"><li>引入 HotModuleReplacementPlugin 插件 (webpack 自带）</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 先引入 webpack</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//...</span>
plugins<span class="token punctuation">:</span><span class="token punctuation">[</span>
	<span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
		template<span class="token punctuation">:</span> <span class="token string">'./src/index.html'</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 使用插件</span>
	<span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre></div><ol start="3"><li>重启一下<code>npm start</code> 使修改后的配置文件生效</li></ol> <p>关于热模块替换的更多用法指南、及实现原理、API 用法可以翻阅以下文档：</p> <p><a href="https://webpack.docschina.org/guides/hot-module-replacement/" target="_blank" rel="noopener noreferrer">指南<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="https://webpack.docschina.org/concepts/hot-module-replacement" target="_blank" rel="noopener noreferrer">概念<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="https://webpack.docschina.org/api/hot-module-replacement" target="_blank" rel="noopener noreferrer">API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="tree-shaking"><a href="#tree-shaking" aria-hidden="true" class="header-anchor">#</a> Tree Shaking</h2> <p>开发过程中我们经常会需要 import 一些外部的公共方法来实现方法复用，但我们大多数时候都是只需要这个公共方法模块里的几个方法，而不是全部。借助 Tree Shaking，我们就可以将模块中没有用到的方法摇晃掉。</p> <blockquote><p>Tree Shaking 只支持 ES module 这种静态的 import 的模块引入方式，而不支持 common js 动态的 require 引入方式。</p></blockquote> <p><strong>配置：</strong> 默认的开发模<code>mode: 'development'</code>  是没有 tree shaking 功能的，要想加上 tree shaking 首先在配置文件中加入 optimization 配置项。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    usedExports<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment">// 只将使用到的导出模块进行打包</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但是这样会可能遗漏掉那些不导出任何内容的模块。实际上，只要 import 引入一个模块，Tree Shaking 就会检查这个模块导出了什么，代码引用了什么，如果没有导出或者没有引用，就会忽略这个模块引入。</p> <p>比如<code>@babel/poly-fill</code>这种只是单纯地在 window 对象上绑定了一些全局变量而不导出内容的模块，或者是代码里引入的一些 CSS、SCSS 样式文件。</p> <p>此时要在 package.json 中加入<code>sideEffects</code>配置，将这些需要特殊处理的模块放进一个数组里。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">'webpack-demo'</span><span class="token punctuation">,</span>
  <span class="token string">&quot;sideEffects&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;@babel/poly-fill&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;*.css&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;*.scss&quot;</span>
  <span class="token punctuation">]</span>
  <span class="token comment">// 如果业务逻辑里没有要特殊处理的模块就直接将 sideEffects 设为 false</span>
  <span class="token comment">// &quot;sideEffects:false&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其实 Development 模式下，即使我们配置了 tree shaking ，它也不会将你不用的代码从打包后的 main.js 中剔除掉，而只是在注释中提醒你一下。🌚</p> <p>这是因为我们在开发环境生成的代码一般都需要做一些调试，如果 tree shaking 把一些代码删除掉的话，sourceMap 代码对应的一些行数就会错误，所以开发环境下的 tree shaking 还会保留这些代码。但是如果我们真正的要将项目打包上线，将 mode 改为 production，那么它就会生效了。但同时要注意这时我们的 devtool 属性在生成环境一般都使用<code>cheap-module-source-map</code>而不是带 eval 的配置。</p> <p>另外在生产环境下，我们甚至都不用写上面的 optimization 配置，它会默认按这个配置去执行。但是 sideEffects 还是要自己配置的。🤪</p> <h2 id="开发与生产模式的配置"><a href="#开发与生产模式的配置" aria-hidden="true" class="header-anchor">#</a> 开发与生产模式的配置</h2> <p>由上可见，开发环境与线上生产环境的配置在很多地方是有区别的。为了方便起见，我们也可以编写两份不同的配置文件，来实现两种环境的切换。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// package.json 文件</span>
<span class="token string">&quot;scripts&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// &quot;start&quot;: &quot;webpack-dev-server --open&quot;  开发环境</span>
  <span class="token string">&quot;dev&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;webpack-dev-server --config webpack.dev.js&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// &quot;build&quot;: &quot;webpack --mode development&quot; 生产环境</span>
  <span class="token string">&quot;build&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;webpack --config webpack.prod.js&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后遵循不重复原则(Don't repeat yourself - DRY)，创建一个 webpack.common.js 文件来报存两种环境下的通用配置。</p> <p>然后再安装使用<code>cnpm i webpack-merge -D</code>将这些配置合并在一起。此工具会引用 &quot;common&quot; 配置，因此我们不必再在环境特定的配置中编写重复代码。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webpack.prod.js</span>
<span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> commonConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.common.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> prodConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
    mode<span class="token punctuation">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
    plugins<span class="token punctuation">:</span><span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            template<span class="token punctuation">:</span> <span class="token string">'./src/index.html'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>commonConfig<span class="token punctuation">,</span> prodConfig<span class="token punctuation">)</span>
</code></pre></div><p>也可以将这些新加的配置文件统一放入一个 build 文件夹内，但同时要注意修改各个配置文件及 package.json 里 script 字段的文件路径。</p> <h2 id="代码分离-code-splitting"><a href="#代码分离-code-splitting" aria-hidden="true" class="header-anchor">#</a> 代码分离 Code Splitting</h2> <p>webpack 默认会根据配置将我们项目的代码都打包到 output 的文件中，但其实我们的项目代码不全是业务代码，肯定会引用一些第三方类库或者像 lodash 这样的工具函数库。如果都各种代码全都打包到一个 JS 文件输出，不仅页面加载这个文件时不仅会很慢，而且一旦业务代码有任何改动，下次访问就需要重新获取。</p> <p>所以我们需要将代码进行分离，然后将不同的代码打包到多个文件输出，这样下次访问时因为浏览器的缓存机制，没有变动的代码文件便不用去重新获取。</p> <blockquote><p>代码分离是 webpack 中最引人注目的特性之一。此特性能够把代码分离到不同的 bundle 中，然后可以按需加载或并行加载这些文件。代码分离可以用于获取更小的 bundle，以及控制资源加载优先级，如果使用合理，会极大影响加载时间。</p></blockquote> <h3 id="入口起点"><a href="#入口起点" aria-hidden="true" class="header-anchor">#</a> 入口起点</h3> <p>代码分离最简单的方法就是通过手动配置 webpack 的入口起点来实现。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 在 src 下新建一个 lodash.js 并将 lodash 挂载到全局</span>
<span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">'lodash'</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span>_ <span class="token operator">=</span> _<span class="token punctuation">;</span>

<span class="token comment">// 配置入口起点</span>
entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    index<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>
    lodash<span class="token punctuation">:</span> <span class="token string">'./src/lodash.js'</span> <span class="token comment">// 打包 lodash.js</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后重新运行打包命令，会发现 dist 下多出一个单独打包 lodash 工具函数库代码的 lodash.js，且打包后的 index.html 里也能自动引入。</p> <p>但这种方式存在一些隐患：</p> <ul><li>如果入口 chunk 之间包含一些重复的模块，那些重复模块都会被引入到各个 bundle 中。</li> <li>这种方法不够灵活，并且不能动态地将核心应用程序逻辑中的代码拆分出来。</li></ul> <p>这两点中的第一点，对我们的示例来说毫无疑问是个严重问题，因为我们如果在 <code>./src/index.js</code> 中也引入 <code>lodash</code>，这样就造成在两个 bundle 中重复引用。我们可以通过使用 <a href="https://webpack.docschina.org/plugins/split-chunks-plugin/" target="_blank" rel="noopener noreferrer"><code>SplitChunksPlugin</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 插件来移除重复模块。</p> <h3 id="去除重复"><a href="#去除重复" aria-hidden="true" class="header-anchor">#</a> 去除重复</h3> <p>其实，本质上 Code Splitting 只是一个分割代码的概念，与 webpack 没有直接关系。但之所以说它是 webpack 的特性是因为 webpack4 里面直接捆绑了<code>SplitChunks</code>这样的插件，我们不用再手动配置或是安装其他插件就可以很方便的实现代码分割。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>
	splitChunks<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    chunks<span class="token punctuation">:</span> <span class="token string">'all'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该插件可以将公共的依赖模块提取到已有的 entry chunk 中，或者提取到一个新生成的 chunk。比如通过设置配置文件的<code>optimization.splitChunks</code>选项，此插件将 <code>lodash</code> 这个沉重负担从主 bundle 中移除，然后分离到一个单独的 chunk 中，同时将项目中重复的依赖项删除掉。</p> <p>另外一些由社区提供，对于代码分离很有帮助的 plugin 和 loader：</p> <ul><li><a href="https://webpack.docschina.org/plugins/mini-css-extract-plugin" target="_blank" rel="noopener noreferrer"><code>mini-css-extract-plugin</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：用于将 CSS 从主应用程序中分离。</li> <li><a href="https://webpack.docschina.org/loaders/bundle-loader" target="_blank" rel="noopener noreferrer"><code>bundle-loader</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：用于分离代码和延迟加载生成的 bundle。</li> <li><a href="https://github.com/gaearon/promise-loader" target="_blank" rel="noopener noreferrer"><code>promise-loader</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：类似于 <code>bundle-loader</code> ，但是使用了 promise API。</li></ul> <h3 id="动态引入"><a href="#动态引入" aria-hidden="true" class="header-anchor">#</a> 动态引入</h3> <p>当涉及到对动态引入的代码进行拆分时，webpack 推荐选择的方案是：使用符合 <a href="https://github.com/tc39/proposal-dynamic-import" target="_blank" rel="noopener noreferrer">ECMAScript 提案<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的 <a href="https://webpack.docschina.org/api/module-methods#import-" target="_blank" rel="noopener noreferrer"><code>import()</code> 语法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 来实现动态导入。👉🏻<a href="https://webpack.docschina.org/guides/code-splitting/#%E5%8A%A8%E6%80%81%E5%AF%BC%E5%85%A5-dynamic-imports-" target="_blank" rel="noopener noreferrer">dynamic imports<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 动态引入 lodash 的 demo </span>
<span class="token keyword">function</span> <span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Lodash, now imported by this script</span>
	<span class="token keyword">return</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> _ <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		element<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Hello'</span><span class="token punctuation">,</span> <span class="token string">'webpack'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'🎉'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> element<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>
    <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token string">'An error occurred while loading the component'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">component</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>由于 <code>import()</code> 会返回一个 promise，因此它可以和<code>async</code>一起使用。但是，需要使用像 Babel 这样的预处理器和 <a href="https://babel.docschina.org/docs/en/babel-plugin-syntax-dynamic-import/#installation" target="_blank" rel="noopener noreferrer">Syntax Dynamic Import Babel Plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Notice the default</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> _ <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: &quot;lodash&quot; */</span> <span class="token string">'lodash'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  element<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Hello'</span><span class="token punctuation">,</span> <span class="token string">'webpack'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> element<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><code>/*webpackChunkName: &quot;lodash&quot;*/</code> ：import() 语法的魔法注释，为动态引入的模板设置打包后的文件名。</p></blockquote> <h2 id="lazy-loading-懒加载"><a href="#lazy-loading-懒加载" aria-hidden="true" class="header-anchor">#</a> Lazy Loading 懒加载</h2> <p>懒加载或者按需加载，并不是 webpack 里的概念，而是一种很好的优化网页或应用的方式。借助 EcmaScript 的 import() 实验性质语法的支持，从而实现先把代码在一些逻辑断点处分离开，然后在代码块中完成某些操作后，再引用另外一些新的代码块。</p> <p>通过懒加载，页面可以在执行的时候需要哪个模块再去请求对应模块的源代码（因为某些代码块可能永远不会被加载），而不是一次性地把所有代码都加载到页面上，减小了总体体积，所以可以加快应用的初始加载速度。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 利用懒加载，只有页面被点击后才会加载 lodash</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">component</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="splitchunksplugin-配置"><a href="#splitchunksplugin-配置" aria-hidden="true" class="header-anchor">#</a> SplitChunksPlugin 配置</h2> <p>上面👆我们通过设置 SplitChunksPlugin 的<code>splitChunks.chunks</code>配置就实现了去除重复依赖项以及同步与异步动态引入代码的打包分离。</p> <p>这是该插件的默认配置：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>
	splitChunks<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  	chunks<span class="token punctuation">:</span> <span class="token string">'async'</span><span class="token punctuation">,</span>
    minSize<span class="token punctuation">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>
    maxSize<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    minChunks<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    maxAsyncRequests<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    maxInitialRequests<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    automaticNameDelimiter<span class="token punctuation">:</span> <span class="token string">'~'</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    	vendors<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      	test<span class="token punctuation">:</span> <span class="token regex">/[\\/]node_modules[\\/]/</span><span class="token punctuation">,</span>
        priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span>
        filename<span class="token punctuation">:</span> <span class="token string">'vendors.js'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      	minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span>
        reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>chunks：</strong> async 只对异步引入的模块进行打包分离，initial 同步，all 两者都可。</p> <p><strong>minSize/maxSize：</strong> 模块的文件大小范围。</p> <p><strong>minChunks：</strong> 打包生成的 chunks 至少有几个引用了该模块，符合条件的模块才会被分离。</p> <p><strong>maxAsyncRequests：</strong> 同时加载的模块数，后续超出部分的模块不会被分离。</p> <p><strong>maxInitialRequests：</strong> 入口文件引用模块代码分离的上限数。</p> <p><strong>automaticNameDelimiter：</strong> 生成的文件名默认连接符。</p> <p><strong>name：</strong> 使下面设置的 filename 生效，从而可以为生成的文件重命名。</p> <p><strong>cacheGroups：</strong> 缓存组 打包同步引入的代码时必须配合这个配置项一起使用才能生效，它决定分离出来的代码到底要放到哪个文件里面。vendors 为默认的分组名，test 为模块来源，priority 当前组的优先级，先放入优先级高的分组下的文件里。reuseExistingChunk 忽略已打包过的模块，直接复用。</p> <p>想要更好的控制代码分离的流程，请查阅<a href="https://webpack.docschina.org/plugins/split-chunks-plugin/" target="_blank" rel="noopener noreferrer">SplitChunksPlugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="prefetch-和-preload"><a href="#prefetch-和-preload" aria-hidden="true" class="header-anchor">#</a> Prefetch 和 Preload</h2> <p>既然我们通过将<code>splitChunks.chunks</code>字段配置成 all 之后，可以同时对同步与异步代码进行分割，将 loadash、jQuery 等代码单独分割打包生成一个文件。在第一次加载后，再次访问就可以使用浏览器缓存来提高访问速度。</p> <p><strong>那为什么 webpack 还要将其默认值设为<code>async,</code>只对异步代码进行分割打包呢？</strong></p> <p>这是因为按照我们的上述配置，只通过将 jQuery、loadash 打包成单独的文件，加载后使用缓存只能提高第二次及以后再访问这些文件时的速度，而不能真正对页面访问性能做优化。webpack 所希望达到的效果是第一次访问页面时，它的速度就是最快的。</p> <div class="language-js extra-class"><pre class="language-js"><code>document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	element<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'Bingo!!!'</span><span class="token punctuation">;</span>
	document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>比如这样一段代码，在页面加载之后，我们可以在 Chrome 控制台通过查看到 Sources 源文件里代码的执行情况以及 Coverage 的 Unused Bytes 覆盖率。 其中点击回调方法里的代码是需要点击之后才会被覆盖执行到的。</p> <p>如果想提高页面核心代码的利用率，我们可以将那些交互之后才用到的代码方法封装到另外一个文件中，再在需要执行的时候将其加载进来。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 将点击的回调方法封装进 click.js</span>
<span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">const</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	element<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'Bingo!!!'</span><span class="token punctuation">;</span>
	document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> handleClick<span class="token punctuation">;</span>
<span class="token comment">// index.js</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token comment">// 这里通过 default 来拿到导出的方法后重命名为 func</span>
	<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./click.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span><span class="token keyword">default</span><span class="token punctuation">:</span> func<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>由此可见，webpack 认为只有这种异步的组件才能真正的提升网页的打包性能。而同步的代码模块只能增加一个缓存，而对性能的提升是有限的。即我们<strong>在做前端代码性能优化的时候，最重要的点其实不是缓存，而是 Code Coverage 代码覆盖率。即缓存带来的代码性能提升是非常有限的，而应该通过提高页面核心代码的覆盖和利用率，从而提升代码性能与页面加载速度。</strong></p> <p>一些网站的登录模态框功能就是使用这种方式去实现的，但是如果我们只在点击后才去加载登录相关的代码，加载速度有可能会比较慢，影响用户体验。那么此时就需要用到 webpack <a href="https://webpack.docschina.org/guides/code-splitting/#%E9%A2%84%E5%8F%96-%E9%A2%84%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9D%97-prefetch-preload-module-" target="_blank" rel="noopener noreferrer">预取 prefetching 和预加载 preloading 模块<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)的功能。从而既能提高首页核心代码的加载速度，同时也可以在页面展示完成后将登陆功能的代码加载进来，保证用户点击登录后的快速响应。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackPrefetch: true */</span> <span class="token string">'./click.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span><span class="token keyword">default</span><span class="token punctuation">:</span> func<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>通过加入<code>/* webpackPrefetch: true */</code>后我们就可以等待页面核心代码加载完成之后，浏览器带宽闲置时再去懒加载 prefetch 对应的文件。</p> <p>至于 webpackPreload，与 webpackPrefetch 不同的一点就在于它是和业务代码主线程一起去加载的。</p> <blockquote><p>这里也并不适用 webpackPreload，关于两者细节的区别请查看文档。另外不正确地使用 webpackPreload 也会有损性能。</p></blockquote> <h2 id="打包分析"><a href="#打包分析" aria-hidden="true" class="header-anchor">#</a> 打包分析</h2> <p>当我们使用 webpack 对各种模块代码进行了分离打包之后，理所应当应该利用一些打包分析的工具来对输出的结果进行检查，分析是否合理。</p> <p>使用<a href="https://github.com/webpack/analyse" target="_blank" rel="noopener noreferrer">webpack 官方打包分析工具<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>生成一个打包分析的说明文件 stats.json，然后可以上传到<a href="http://webpack.github.com/analyse" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>上查看结果。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// package.json</span>
<span class="token string">&quot;scripts&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// 可以在 build 字段中加入 --profile --json &gt; stats.json </span>
  <span class="token string">&quot;build&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;webpack --profile --json &gt; stats.json --config webpack.prod.js&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// 也可以专门添加一条生成分析文件的指令</span>
  <span class="token string">&quot;analyse&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;webpack --profile --json  &gt; stats.json&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>其他一些打包分析的可视化工具：</p> <ul><li><a href="https://alexkuz.github.io/webpack-chart/" target="_blank" rel="noopener noreferrer">webpack-chart<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：webpack stats 可交互饼图。</li> <li><a href="https://chrisbateman.github.io/webpack-visualizer/" target="_blank" rel="noopener noreferrer">webpack-visualizer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：可视化并分析你的 bundle，检查哪些模块占用空间，哪些可能是重复使用的。</li> <li><a href="https://github.com/webpack-contrib/webpack-bundle-analyzer" target="_blank" rel="noopener noreferrer">webpack-bundle-analyzer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：一个 plugin 和 CLI 工具，它将 bundle 内容展示为便捷的、交互式、可缩放的树状图形式。</li> <li><a href="https://webpack.jakoblind.no/optimize" target="_blank" rel="noopener noreferrer">webpack bundle optimize helper<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：此工具会分析你的 bundle，并为你提供可操作的改进措施建议，以减少 bundle 体积大小。</li></ul></div></article> <section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      发布时间 : 2019-09-06
    </span> <!----></section> <section class="post-links" data-v-4e23451f><a href="/posts/2019/07/05/react-docs-notes.html" class="post-link" data-v-4e23451f>
      上一篇 : React文档学习笔记
    </a> <!----></section></section> <!----></div></main> <aside class="aside" data-v-6cd81e6a><div class="info-card main-div" data-v-3da8ff8d data-v-6cd81e6a><div class="info-card-header" data-v-3da8ff8d><img src="/img/avatar.png" alt="W-Qing" class="info-avatar" data-v-3da8ff8d></div> <div class="info-card-body" data-v-3da8ff8d><section class="info-nickname" data-v-3da8ff8d>
      W-Qing
    </section> <section class="info-desc" data-v-3da8ff8d>I may be lonely,<br/>but l'm not stupid,<br/>l try to live with my mistake.</section> <section class="info-contact" data-v-3da8ff8d><section data-v-3da8ff8d><span title="Shanghai City, China" data-v-3da8ff8d data-v-3da8ff8d><svg class="icon" style="font-size:1em;" data-v-3da8ff8d data-v-3da8ff8d><title data-v-3da8ff8d data-v-3da8ff8d>Shanghai City, China</title><use xlink:href="#icon-location" data-v-3da8ff8d data-v-3da8ff8d></use></svg><span class="info-text" data-v-3da8ff8d data-v-3da8ff8d>
          Shanghai City, China
        </span></span></section> <section data-v-3da8ff8d><span title="Ludong University" data-v-3da8ff8d data-v-3da8ff8d><svg class="icon" style="font-size:1em;" data-v-3da8ff8d data-v-3da8ff8d><title data-v-3da8ff8d data-v-3da8ff8d>Ludong University</title><use xlink:href="#icon-organization" data-v-3da8ff8d data-v-3da8ff8d></use></svg><span class="info-text" data-v-3da8ff8d data-v-3da8ff8d>
          Ludong University
        </span></span></section> <section data-v-3da8ff8d><a href="mailto:sunburst.wang@qq.com" title="sunburst.wang@qq.com" data-v-3da8ff8d data-v-3da8ff8d><svg class="icon" style="font-size:1em;" data-v-3da8ff8d data-v-3da8ff8d><title data-v-3da8ff8d data-v-3da8ff8d>sunburst.wang@qq.com</title><use xlink:href="#icon-email" data-v-3da8ff8d data-v-3da8ff8d></use></svg><span class="info-text" data-v-3da8ff8d data-v-3da8ff8d>
          sunburst.wang@qq.com
        </span></a></section></section></div> <div class="info-card-footer" data-v-3da8ff8d><section class="info-sns clearfix" data-v-3da8ff8d><a href="https://github.com/W-Qing" target="_blank" class="sns-link" data-v-3da8ff8d><span title="GitHub: W-Qing" class="sns-icon" data-v-3da8ff8d data-v-3da8ff8d><svg class="icon" style="font-size:1.5em;" data-v-3da8ff8d data-v-3da8ff8d><title data-v-3da8ff8d data-v-3da8ff8d>GitHub: W-Qing</title><use xlink:href="#icon-github" data-v-3da8ff8d data-v-3da8ff8d></use></svg></span></a></section></div></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-6cd81e6a><div class="post-nav-contents"><svg class="icon"><title>book</title><use xlink:href="#icon-book"></use></svg> <span>文章目录</span> <div class="post-nav-toc"><ul><li><a href="/posts/2019/09/06/webpack-advanced-learning-1.html#entry-与-output-的基础配置">Entry 与 Output 的基础配置</a></li><li><a href="/posts/2019/09/06/webpack-advanced-learning-1.html#source-map-的配置">Source Map 的配置</a></li><li><a href="/posts/2019/09/06/webpack-advanced-learning-1.html#模块热更新-hot-module-replace">模块热更新 Hot Module Replace</a></li><li><a href="/posts/2019/09/06/webpack-advanced-learning-1.html#tree-shaking">Tree Shaking</a></li><li><a href="/posts/2019/09/06/webpack-advanced-learning-1.html#开发与生产模式的配置">开发与生产模式的配置</a></li><li><a href="/posts/2019/09/06/webpack-advanced-learning-1.html#代码分离-code-splitting">代码分离 Code Splitting</a><ul><li><a href="/posts/2019/09/06/webpack-advanced-learning-1.html#入口起点">入口起点</a></li><li><a href="/posts/2019/09/06/webpack-advanced-learning-1.html#去除重复">去除重复</a></li><li><a href="/posts/2019/09/06/webpack-advanced-learning-1.html#动态引入">动态引入</a></li></ul></li><li><a href="/posts/2019/09/06/webpack-advanced-learning-1.html#lazy-loading-懒加载">Lazy Loading 懒加载</a></li><li><a href="/posts/2019/09/06/webpack-advanced-learning-1.html#splitchunksplugin-配置">SplitChunksPlugin 配置</a></li><li><a href="/posts/2019/09/06/webpack-advanced-learning-1.html#prefetch-和-preload">Prefetch 和 Preload</a></li><li><a href="/posts/2019/09/06/webpack-advanced-learning-1.html#打包分析">打包分析</a></li></ul></div></div> <!----></div></aside></div> <footer class="footer" data-v-1114308c><p class="sns-links" data-v-1114308c><a href="https://github.com/W-Qing" target="_blank" class="sns-link" data-v-1114308c><span title="GitHub: W-Qing" class="sns-icon" data-v-1114308c data-v-1114308c><svg class="icon" style="font-size:25px;" data-v-1114308c data-v-1114308c><title data-v-1114308c data-v-1114308c>GitHub: W-Qing</title><use xlink:href="#icon-github" data-v-1114308c data-v-1114308c></use></svg></span></a></p> <p data-v-1114308c><span data-v-1114308c>Powered by </span> <a href="https://vuepress.vuejs.org" target="_blank" data-v-1114308c>
      Vuepress
    </a></p></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/vendor.2.8681790c.js" defer></script><script src="/assets/js/25.b68f41ab.js" defer></script><script src="/assets/js/vendor.1.d0cf3ae5.js" defer></script><script src="/assets/js/vendor.0.6b1a4519.js" defer></script><script src="/assets/js/app.a5059352.js" defer></script>
  </body>
</html>
